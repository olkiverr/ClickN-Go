
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ClickN'Go</title>
    <link rel="icon" href="/img/logo.png" type="image/png">
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body data-theme="dark">
    <%- include('partials/header') %>
    <main class="section-container">
        <h2 class="section-title">Checkout</h2>
        <% if (items.length === 0) { %>
            <p>Your cart is empty. Please add some products before checking out.</p>
            <a href="/products" class="btn-primary">Continue Shopping</a>
        <% } else { %>
            <div class="products-grid" style="grid-template-columns: 1fr;">
                <% items.forEach(item => { %>
                    <div class="product-card" style="display: flex; align-items: center; text-align: left;">
                        <img src="<%= item.product.image_url %>" alt="<%= item.product.name %>" style="width: 100px; height: 100px; object-fit: contain; margin-right: 1.5rem;">
                        <div class="product-info" style="flex-grow: 1;">
                            <h3 class="product-title"><%= item.product.name %></h3>
                            <p>Quantity: <%= item.quantity %></p>
                            <p>Unit Price: $<%= item.product.price %></p>
                        </div>
                        <div style="margin-left: auto; text-align: right;">
                            <p class="price-current">Total: $<%= item.itemTotal.toFixed(2) %></p>
                        </div>
                    </div>
                <% }) %>
            </div>
            <div class="cart-total" style="text-align: right; margin-top: 2rem; font-size: 1.8rem; font-weight: bold;">
                <strong>Order Total: $<%= totalPrice.toFixed(2) %></strong>
            </div>
            
            <form action="/cart/checkout" method="POST" class="auth-form" style="max-width: 800px; margin-top: 2rem;">
                <h3 class="section-title" style="text-align: left; margin-bottom: 1.5rem;">Shipping Information</h3>
                <label for="address">Address</label>
                <input type="text" id="address" name="shipping_address" autocomplete="shipping street-address" required>

                <label for="city">City</label>
                <input type="text" id="city" name="shipping_city" autocomplete="shipping address-level2" required>

                <label for="zip">Zip Code</label>
                <input type="text" id="zip" name="shipping_zip" autocomplete="shipping postal-code" required>

                <label for="country">Country</label>
                <input type="text" id="country" name="shipping_country" autocomplete="shipping country-name" required>

                <h3 class="section-title" style="text-align: left; margin-top: 2rem; margin-bottom: 1.5rem;">Payment Information</h3>

                <label for="cardNumber">Card Number</label>
                <input type="text" id="cardNumber" name="card_number" placeholder="XXXX XXXX XXXX XXXX" inputmode="numeric" autocomplete="cc-number" maxlength="19" required>

                <div style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label for="expDate">Expiration Date</label>
                        <input type="text" id="expDate" name="exp_date" placeholder="MM/YY" inputmode="numeric" autocomplete="cc-exp" maxlength="5" required>
                    </div>
                    <div style="flex: 1;">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" name="cvv" placeholder="XXX" inputmode="numeric" autocomplete="cc-csc" maxlength="3" required>
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem; margin-top: 2rem;">Place Order</button>
            </form>
        <% } %>
    </main>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cardNumberInput = document.getElementById('cardNumber');
            const expDateInput = document.getElementById('expDate');
            const cvvInput = document.getElementById('cvv');

            // Card Number Formatting (XXXX XXXX XXXX XXXX)
            cardNumberInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                value = value.substring(0, 16); // Limit to 16 digits
                const parts = [];
                for (let i = 0; i < value.length; i += 4) {
                    parts.push(value.substring(i, i + 4));
                }
                e.target.value = parts.join(' ');
            });

            // Expiration Date Formatting (MM/YY)
            expDateInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
                if (value.length >= 2) {
                    // Ensure month is valid (01-12)
                    let month = parseInt(value.substring(0, 2), 10);
                    if (month === 0) value = '01'; // Prevent 00
                    if (month > 12) value = '12'; // Cap at 12
                }
                
                if (value.length > 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value.substring(0, 5); // Limit to MM/YY
            });

            // CVV Validation (3 digits)
            cvvInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3); // Limit to 3 digits
            });
        });
    </script>
</body>
</html>
